<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BHASKAR PROFESSIONAL FLEET - LIVE MAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        #map { height: 400px; width: 100%; border-radius: 24px; margin-bottom: 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.15); border: 4px solid white; z-index: 10; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .online { background-color: #22c55e; box-shadow: 0 0 10px #22c55e; animation: pulse 1.5s infinite; }
        .offline { background-color: #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        /* ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç ‡∞ê‡∞ï‡∞æ‡∞®‡±ç ‡∞∏‡±ç‡∞ü‡±à‡∞≤‡±ç */
        .car-marker-icon { filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); transform-origin: center; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-overlay" class="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 shadow-2xl text-center border-t-8 border-blue-600">
            <h2 class="text-2xl font-black text-slate-800 uppercase mb-2">Fleet Access</h2>
            <p class="text-xs text-gray-400 mb-6 uppercase tracking-widest">Authorized Personnel Only</p>
            <div id="user-field-area">
                <input id="user-input" type="text" placeholder="Username" class="w-full p-4 border-2 rounded-xl mb-3 text-center font-bold outline-none focus:border-blue-500">
            </div>
            <input id="pass-input" type="password" placeholder="Password" class="w-full p-4 border-2 rounded-xl mb-6 text-center font-bold outline-none focus:border-blue-500">
            <button id="login-btn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase shadow-lg hover:bg-blue-700 transition-all">Unlock Fleet</button>
        </div>
    </div>

    <div id="main-content" class="hidden">
        <header class="bg-[#003399] text-white p-6 text-center shadow-lg border-b-4 border-yellow-400 relative">
            <h1 class="text-2xl font-black uppercase tracking-tighter">BHASKAR FLEET LIVE</h1>
            <p class="text-yellow-300 font-bold mt-1 uppercase text-[10px] tracking-[0.2em]">Premium Live Tracking System</p>
            <button onclick="logout()" class="absolute right-4 top-5 text-[10px] bg-red-600 px-3 py-1 rounded-full font-bold uppercase text-white shadow hover:bg-red-700">Logout</button>
        </header>

        <main class="max-w-5xl mx-auto p-4">
            <div class="bg-white p-3 rounded-[32px] shadow-xl mb-6 border border-gray-100">
                <div class="flex justify-between items-center px-4 py-2">
                    <h3 class="font-black text-slate-700 uppercase flex items-center gap-2 text-sm">
                        <span class="text-blue-600 text-lg">üìç</span> Nearby Drivers (Live)
                    </h3>
                </div>
                <div id="map"></div>
            </div>

            <div id="fleet-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC7omObD0cWgdqGsNq-8L7n9i_Akp_JCEM",
            authDomain: "master-web-app-d8d1b.firebaseapp.com",
            databaseURL: "https://master-web-app-d8d1b-default-rtdb.firebaseio.com",
            projectId: "master-web-app-d8d1b",
            appId: "1:460731698074:web:40ad4f12c5fb3126874823"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let map;
        let markers = {};
        let driverData = {}; // ‡∞∏‡±ç‡∞ü‡±ã‡∞∞‡±ç ‡∞°‡±ç‡∞∞‡±à‡∞µ‡∞∞‡±ç ‡∞°‡±Ä‡∞ü‡±Ü‡∞Ø‡∞ø‡∞≤‡±ç‡∞∏‡±ç

        // ‡∞ê‡∞ï‡∞æ‡∞®‡±ç ‡∞∏‡±Ü‡∞ü‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç
        const carIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png', 
            iconSize: [40, 40],
            iconAnchor: [20, 20],
            popupAnchor: [0, -20],
            className: 'car-marker-icon'
        });

        function initMap() {
            if (map) return;
            map = L.map('map').setView([13.6288, 79.4192], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
        }

        function loadFleet() {
            initMap();
            const container = document.getElementById('fleet-container');
            
            for (let i = 1; i <= 20; i++) {
                const taxiId = 'taxi' + i;
                
                // 1. ‡∞°‡±ç‡∞∞‡±à‡∞µ‡∞∞‡±ç ‡∞™‡±á‡∞∞‡±Å & ‡∞®‡∞Ç‡∞¨‡∞∞‡±ç ‡∞∏‡±Ü‡∞ü‡±ç‡∞ü‡∞ø‡∞Ç‡∞ó‡±ç‡∞∏‡±ç ‡∞®‡±Å‡∞Ç‡∞°‡∞ø ‡∞§‡±Ä‡∞∏‡±Å‡∞ï‡±Å‡∞Ç‡∞ü‡±Å‡∞Ç‡∞¶‡∞ø
                onValue(ref(db, taxiId + '/settings'), (snap) => {
                    const data = snap.val();
                    if (data && data.driverName) {
                        driverData[taxiId] = data; // ‡∞∏‡±á‡∞µ‡±ç ‡∞°‡±á‡∞ü‡∞æ
                        renderCard(taxiId, data);
                    }
                });

                // 2. ‡∞≤‡±à‡∞µ‡±ç ‡∞≤‡±ä‡∞ï‡±á‡∞∑‡∞®‡±ç ‡∞ü‡±ç‡∞∞‡∞æ‡∞ï‡∞ø‡∞Ç‡∞ó‡±ç
                onValue(ref(db, taxiId + '/location'), (snap) => {
                    const loc = snap.val();
                    if (loc && loc.lat && loc.lng) {
                        updateTracking(taxiId, loc);
                    }
                });
            }
        }

        function renderCard(taxiId, data) {
            const container = document.getElementById('fleet-container');
            const siteUrl = `https://bhaskar28051975-ctrl.github.io/master-web-app/index.html?id=${taxiId}`;
            
            let card = document.getElementById(`card-${taxiId}`);
            const cardHTML = `
                <div id="card-${taxiId}" class="bg-white rounded-3xl shadow-lg border-l-[10px] border-blue-600 p-5 transition-all active:scale-95 border border-gray-100">
                    <div class="flex justify-between items-start mb-1">
                        <h2 class="text-lg font-black text-slate-800 uppercase leading-none">${data.driverName}</h2>
                        <span id="status-${taxiId}" class="text-[9px] font-black uppercase flex items-center">
                            <span class="status-dot offline"></span>Offline
                        </span>
                    </div>
                    <p class="text-blue-600 font-bold text-[11px] mb-4 uppercase tracking-tighter">${data.taxiModel || 'Vehicle'} | ${data.taxiNo || '---'}</p>
                    <div class="flex gap-2">
                        <a href="${siteUrl}" target="_blank" class="flex-1 bg-blue-600 text-white text-center py-3 rounded-2xl font-black text-[10px] uppercase shadow-md">Open App</a>
                        <button onclick="focusDriver('${taxiId}')" class="bg-gray-100 p-3 rounded-2xl border border-gray-200 hover:bg-blue-50 transition-colors">üìç</button>
                    </div>
                </div>`;

            if (card) {
                card.outerHTML = cardHTML;
            } else {
                container.insertAdjacentHTML('beforeend', cardHTML);
            }
        }

        function updateTracking(taxiId, loc) {
            const now = Date.now();
            const lastSeen = loc.lastSeen || 0;
            const isOnline = (now - lastSeen) < 120000; // 2 ‡∞®‡∞ø‡∞Æ‡∞ø‡∞∑‡∞æ‡∞≤‡±Å

            const statusEl = document.getElementById(`status-${taxiId}`);
            if (statusEl) {
                if (isOnline) {
                    statusEl.innerHTML = `<span class="status-dot online"></span><span class="text-green-600">Live Now</span>`;
                } else {
                    statusEl.innerHTML = `<span class="status-dot offline"></span><span class="text-gray-400">Offline</span>`;
                }
            }

            // ‡∞Æ‡±ç‡∞Ø‡∞æ‡∞™‡±ç ‡∞Æ‡±Ä‡∞¶ ‡∞ï‡∞æ‡∞∞‡±Å ‡∞Æ‡∞æ‡∞∞‡±ç‡∞ï‡∞∞‡±ç ‡∞Ö‡∞™‡±ç‚Äå‡∞°‡±á‡∞ü‡±ç
            if (isOnline) {
                const driver = driverData[taxiId] || { driverName: taxiId };
                if (markers[taxiId]) {
                    markers[taxiId].setLatLng([loc.lat, loc.lng]);
                } else {
                    markers[taxiId] = L.marker([loc.lat, loc.lng], { icon: carIcon }).addTo(map)
                        .bindPopup(`<div style="text-align:center;"><b>${driver.driverName}</b><br><span style="font-size:10px; color:blue;">${driver.taxiNo || ''}</span></div>`);
                }
            } else if (markers[taxiId]) {
                map.removeLayer(markers[taxiId]);
                delete markers[taxiId];
            }
        }

        window.focusDriver = (id) => {
            if (markers[id]) {
                map.setView(markers[id].getLatLng(), 16);
                markers[id].openPopup();
            } else { 
                alert("‡∞°‡±ç‡∞∞‡±à‡∞µ‡∞∞‡±ç ‡∞™‡±ç‡∞∞‡∞∏‡±ç‡∞§‡±Å‡∞§‡∞Ç ‡∞Ü‡∞´‡±ç‚Äå‡∞≤‡±à‡∞®‡±ç‚Äå‡∞≤‡±ã ‡∞â‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å."); 
            }
        };

        // Login Logic
        document.getElementById('login-btn').onclick = async () => {
            const u = document.getElementById('user-input').value.toLowerCase().trim();
            const p = document.getElementById('pass-input').value;
            
            if (u === "admin" && p === "1234") {
                loginOk();
            } else {
                const agentsSnap = await get(ref(db, 'agents'));
                let authorized = false;
                agentsSnap.forEach(child => {
                    if(child.val().username === u && child.val().password === p) authorized = true;
                });
                if(authorized) loginOk(); else alert("Invalid Login");
            }
        };

        function loginOk() { sessionStorage.setItem("fleet_unlocked", "true"); location.reload(); }
        window.logout = () => { sessionStorage.removeItem("fleet_unlocked"); location.reload(); };

        if (sessionStorage.getItem("fleet_unlocked") === "true") {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            loadFleet();
        }
    </script>
</body>
</html>
